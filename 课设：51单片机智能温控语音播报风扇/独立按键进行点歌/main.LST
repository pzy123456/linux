C51 COMPILER V9.52.0.0   MAIN                                                              06/06/2019 21:11:38 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\keil4\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /**************************************************************************************
   2          *                 独立按键实验                          *
   3          实现现象：下载程序后按下K1按键可以播放02文件夹下的001，按k2按键可以播放02的002
   4          注意事项：无                                          
   5          ***************************************************************************************/
   6          
   7          #include "reg52.h"       //此文件中定义了单片机的一些特殊功能寄存器
   8          
   9          typedef unsigned int u16;   //对数据类型进行声明定义
  10          typedef unsigned char u8;
  11          
  12          sbit k1=P3^2;  //定义P31口是k1
  13          sbit k2=P3^3;  //定义P30口是k2
  14          
  15          void UsartInit();
  16          void Uart_PutByte(u8 ch);
  17          void Uart_SendCMD(u8 CMD ,u8 feedback , u16 dat);
  18          void DoSum( u8 *Str, u8 len);
  19          u8 Send_buf[10] = {0};
  20          /*******************************************************************************
  21          * 函 数 名         : delay
  22          * 函数功能         : 延时函数，i=1时，大约延时10us
  23          *******************************************************************************/
  24          void delay(u16 i)
  25          {
  26   1        while(i--); 
  27   1      }
  28          
  29          /*******************************************************************************
  30          * 函 数 名         : keypros
  31          * 函数功能       : 按键处理函数，判断按键K1是否按下
  32          *******************************************************************************/
  33          void keypros()
  34          {
  35   1        if(k1==0)     //检测按键K1是否按下
  36   1        { 
  37   2          delay(3000);   //消除抖动 一般大约10ms
  38   2          if(k1==0)  //再次判断按键是否按下
  39   2          {
  40   3            Uart_SendCMD(0x0f , 0 , 0x0201) ;
  41   3          }
  42   2          while(!k1);  //检测按键是否松开
  43   2        }   
  44   1        if(k2==0)     //检测按键K1是否按下
  45   1        { 
  46   2          delay(3000);   //消除抖动 一般大约10ms
  47   2          if(k2==0)  //再次判断按键是否按下
  48   2          {
  49   3            Uart_SendCMD(0x0f , 0 , 0x0202) ;
  50   3          }
  51   2          while(!k2);  //检测按键是否松开
  52   2        }
  53   1      
  54   1        
  55   1      }
C51 COMPILER V9.52.0.0   MAIN                                                              06/06/2019 21:11:38 PAGE 2   

  56          
  57          /*******************************************************************************
  58          * 函 数 名       : main
  59          * 函数功能     : 主函数
  60          * 输    入       : 无
  61          * 输    出       : 无
  62          *******************************************************************************/
  63          void main()
  64          { 
  65   1        
  66   1        while(1)
  67   1        { 
  68   2          UsartInit();
  69   2          keypros();  //按键处理函数  
  70   2        }   
  71   1      }
  72          /*******************************************************************************
  73          * 函数名         :UsartInit()
  74          * 函数功能       :设置串口
  75          * 输入           : 无
  76          * 输出           : 无
  77          *******************************************************************************/
  78          void UsartInit()
  79          {
  80   1        SCON=0X50;      //设置为工作方式1
  81   1        TMOD=0X20;      //设置计数器工作方式2
  82   1        PCON=0X00;      //波特率不加倍
  83   1        TH1=0XFD;       //计数器初始值设置，注意波特率是9600的
  84   1        TL1=0XFD;
  85   1        ES=1;           //打开接收中断
  86   1        REN = 1;        //串口使能
  87   1        TR1=1;          //打开计数器
  88   1      }
  89          /********************************************************************************************
  90           - 功能描述： 串口发送一个字节
  91           - 隶属模块： 外部
  92           - 参数说明：
  93           - 返回说明：
  94           - 注：       
  95          ********************************************************************************************/
  96          void Uart_PutByte(u8 ch)
  97          {
  98   1          SBUF  = ch;
  99   1          while(!TI){;}
 100   1          TI = 0;
 101   1      }
 102          /*****************************************************************************************************
 103           - 功能描述： 串口发送一帧数据
 104           - 隶属模块： 内部 
 105           - 参数说明： 
 106           - 返回说明： 
 107           - 注：无     
 108          *****************************************************************************************************/
 109          void SendCmd(u8 len)
 110          {
 111   1          u8 i = 0 ;
 112   1      
 113   1          Uart_PutByte(0x7E); //起始
 114   1          for(i=0; i<len; i++)//数据
 115   1          {
 116   2          Uart_PutByte(Send_buf[i]) ;
 117   2          }
C51 COMPILER V9.52.0.0   MAIN                                                              06/06/2019 21:11:38 PAGE 3   

 118   1          Uart_PutByte(0xEF) ;//结束
 119   1      }
 120          
 121          /********************************************************************************************
 122           - 功能描述：求和校验
 123           - 隶属模块：
 124           - 参数说明：
 125           - 返回说明：
 126           - 注：      和校验的思路如下
 127                       发送的指令，去掉起始和结束。将中间的6个字节进行累加，最后取反码
 128                       接收端就将接收到的一帧数据，去掉起始和结束。将中间的数据累加，再加上接收到的校验
 129                       字节。刚好为0.这样就代表接收到的数据完全正确。
 130          ********************************************************************************************/
 131          void DoSum( u8 *Str, u8 len)
 132          {
 133   1          u16 xorsum = 0;
 134   1          u8 i;
 135   1      
 136   1          for(i=0; i<len; i++)
 137   1          {
 138   2              xorsum  = xorsum + Str[i];
 139   2          }
 140   1        xorsum     = 0 -xorsum;
 141   1        *(Str+i)   = (u8)(xorsum >>8);
 142   1        *(Str+i+1) = (u8)(xorsum & 0x00ff);
 143   1      }
 144          
 145          
 146          /********************************************************************************************
 147           - 功能描述： 串口向外发送命令[包括控制和查询]
 148           - 隶属模块： 外部
 149           - 参数说明： CMD:表示控制指令，请查阅指令表，还包括查询的相关指令
 150                        feedback:是否需要应答[0:不需要应答，1:需要应答]
 151                        data:传送的参数
 152           - 返回说明：
 153           - 注：       
 154          ********************************************************************************************/
 155          void Uart_SendCMD(u8 CMD ,u8 feedback , u16 dat)
 156          {
 157   1          Send_buf[0] = 0xff;    //保留字节 
 158   1          Send_buf[1] = 0x06;    //长度
 159   1          Send_buf[2] = CMD;     //控制指令
 160   1          Send_buf[3] = feedback;//是否需要反馈
 161   1          Send_buf[4] = (u8)(dat >> 8);//datah
 162   1          Send_buf[5] = (u8)(dat);     //datal
 163   1          DoSum(&Send_buf[0],6);        //校验
 164   1          SendCmd(8);       //发送此帧数据
 165   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    249    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     10       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
